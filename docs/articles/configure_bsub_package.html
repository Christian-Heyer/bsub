<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configure bsub package • bsub</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Configure bsub package">
<meta property="og:description" content="bsub">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bsub</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bsub_intro.html">Send R code/R scripts/shell commands to LSF cluster</a>
    </li>
    <li>
      <a href="../articles/configure_bsub_package.html">Configure bsub package</a>
    </li>
    <li>
      <a href="../articles/two_ssh.html">What if you need to establish two ssh connections to reach the submission node</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jokergoo/bsub/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="configure_bsub_package_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Configure bsub package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jokergoo/bsub/blob/master/vignettes/configure_bsub_package.Rmd"><code>vignettes/configure_bsub_package.Rmd</code></a></small>
      <div class="hidden name"><code>configure_bsub_package.Rmd</code></div>

    </div>

    
    
<p><strong>Author</strong>: Zuguang Gu ( <a href="mailto:z.gu@dkfz.de" class="email">z.gu@dkfz.de</a> )</p>
<p><strong>Date</strong>: 2020-06-05</p>
<hr>
<p>The <strong>bsub</strong> package is only broadly tested on DKFZ ODCF cluster and the default configurations work fine there. It is also possible for other clusters that use LSF system to use <strong>bsub</strong> package. The following global options should be properly configured.</p>
<p>If you have difficulties to configure <strong>bsub</strong> package for your cluster, please feel free to contact me. I am glad to help.</p>
<p>You can find examples from <a href="https://github.com/jokergoo/bsub/blob/master/R/config.R" class="uri">https://github.com/jokergoo/bsub/blob/master/R/config.R</a>.</p>
<div id="how-to-call-rscript-command" class="section level3">
<h3 class="hasAnchor">
<a href="#how-to-call-rscript-command" class="anchor"></a>How to call Rscript command</h3>
<p>You need to configure how to call the <code>Rscript</code> command, especially when you have different versions of R installed. Following is how we call <code>Rscript</code> on our cluster (we use <code>module</code> to manage the bash environment).</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">call_Rscript</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">version</span>) {
    <span class="fu">qq</span>(<span class="st">"module load gcc/7.2.0; module load java/1.8.0_131; module load R/@{version}; Rscript"</span>)
}</pre></body></html></div>
<p>Then the different version of <code>Rscript</code> can be switched by setting different <code>bsub_opt$R_version</code> option (The value of <code>bsub_opt$R_version</code> will be passed to the <code>call_Rscript()</code> function.</p>
<p>Similarlly, if you use <a href="https://docs.conda.io/en/latest/">conda</a> for managing different versions of software, you can also choose R with different versions by setting a proper <code>bsub_opt$call_Rscript</code>. Let assume you have conda environments for different R versions with the naming schema <code>R_$version</code> (e.g. R_3.6.0), then you can set <code>bsub_opt$call_Rscript</code> as:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">call_Rscript</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">version</span>) {
    <span class="fu">qq</span>(<span class="st">"conda activate R_@{version}; Rscript"</span>)
}</pre></body></html></div>
</div>
<div id="submission-node" class="section level3">
<h3 class="hasAnchor">
<a href="#submission-node" class="anchor"></a>Submission node</h3>
<p>The names of the nodes where the jobs are submitted can be set by <code>bsub_opt$submission_node</code> option. The value can be a vector of node names. <strong>bsub</strong> will randomly select one to connect.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">submission_node</span> <span class="kw">=</span> <span class="no">...</span></pre></body></html></div>
</div>
<div id="login-node" class="section level3">
<h3 class="hasAnchor">
<a href="#login-node" class="anchor"></a>Login node</h3>
<p>If you want to submit jobs, the login node should be the same as the submission node. By default, the value for <code>login_node</code> is automatically copied from <code>submission_node</code>. But there are cases when the login node is different from the submission node. For example, If you are working on your own laptop, to connect to your institute’s cluster, you need to first connect to server A to enter your institute’s network, then on server A, you continue to connect to server B which is the submission node. In this case, server A is the login node. When you explicitly set <code>login_node</code>, you should also set <code>submission_node</code> to <code>NULL</code> because in this circumstance, you cannot submit jobs:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">login_node</span> <span class="kw">=</span> <span class="st">"server A"</span>
<span class="no">bsub_opt</span>$<span class="no">submission_node</span> <span class="kw">=</span> <span class="kw">NULL</span></pre></body></html></div>
<p>You can still query job status. Please refer to <a href="two_ssh.html">two_ssh.html</a> to see the instructions of how to configure <strong>bsub</strong> packages when you need to establish two connections to the submission node.</p>
</div>
<div id="username-on-the-submission-node" class="section level3">
<h3 class="hasAnchor">
<a href="#username-on-the-submission-node" class="anchor"></a>Username on the submission node</h3>
<p>Your username on the submission node can be set by <code>bsub_opt$user</code>. The default value is <code>Sys.info()['user']</code>. If the username on the submission node is different, you need to explicitly set it.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">user</span> <span class="kw">=</span> <span class="no">...</span></pre></body></html></div>
</div>
<div id="bash-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#bash-environment" class="anchor"></a>Bash environment</h3>
<p><code>bsub_opt$ssh_envir</code> should be properly set so that LSF binaries such as <code>bsub</code> or <code>bjobs</code> can be found. There are some environment variables initialized when logging in the bash terminal while they are not initialized with the ssh connection. Thus, some environment variables should be manually set.</p>
<p>An example for <code>bsub_opt$ssh_envir</code> is as follows. The <code>LSF_ENVDIR</code> and <code>LSF_SERVERDIR</code> should be defined and exported.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">ssh_envir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"source /etc/profile"</span>,
                       <span class="st">"export LSF_ENVDIR=/opt/lsf/conf"</span>,
                       <span class="st">"export LSF_SERVERDIR=/opt/lsf/10.1/linux3.10-glibc2.17-x86_64/etc"</span>)</pre></body></html></div>
<p>The values of these two variables can be obtained by entering following commands in your bash terminal (on the submission node):</p>
<pre><code>echo $LSF_ENVDIR
echo $LSF_SERVERDIR</code></pre>
</div>
<div id="bsub-template" class="section level3">
<h3 class="hasAnchor">
<a href="#bsub-template" class="anchor"></a>bsub template</h3>
<p>You need to define the template for calling the <code>bsub</code> command by <code>bsub_opt$bsub_template</code> option. The self-defined function should accepts following arguments:</p>
<ul>
<li>
<code>name</code> job name.</li>
<li>
<code>hour</code> running time.</li>
<li>
<code>memory</code> memory, in GB.</li>
<li>
<code>core</code> number of cores to use.</li>
<li>
<code>output</code> path of output file.</li>
<li>
<code>...</code> should be added as the last argument of the function.</li>
</ul>
<p>The temporary bash script to submit is automatically appended as the last argument of <code>bsub</code>.</p>
<p><em>E.g.</em>, the template on our cluster is defined as:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">bsub_template</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">name</span>, <span class="no">hour</span>, <span class="no">memory</span>, <span class="no">core</span>, <span class="no">output</span>, <span class="no">...</span>) {
    <span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"bsub -J '{name}' -W '{hour}:00' -n {core} -R 'rusage[mem={memory}GB]' -o '{output}'"</span>)
}</pre></body></html></div>
<p>You can use <code><a href="https://glue.tidyverse.org/reference/glue.html">glue::glue()</a></code> or <code><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">GetoptLong::qq()</a></code> to construct a complex string with interpolating multiple variables.</p>
</div>
<div id="how-to-parse-the-time-strings" class="section level3">
<h3 class="hasAnchor">
<a href="#how-to-parse-the-time-strings" class="anchor"></a>How to parse the time strings</h3>
<p>The time strings by LSF <code>bjobs</code> command might be different for different installations. The <strong>bsub</strong> package needs to convert the time strings to <code>POSIXlt</code> objects for calculating the time difference in the <code><a href="../reference/bjobs.html">bjobs()</a></code> function. Thus, if the default time string parsing fails, users need to provide a user-defined function and set with <code>bsub_opt$parse_time</code> option in <code>bsub_opt</code>. The function accepts a vector of time strings and returns a <code>POSIXlt</code> object. For example, if the time string returned from <code>bjobs</code> command is in a form of <code>Dec 1 18:00:00 2019</code>, the parsing function can be defined as:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">bsub_opt</span>$<span class="no">parse_time</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span>(<span class="no">x</span>, <span class="kw">format</span> <span class="kw">=</span> <span class="st">"%b %d %H:%M:%S %Y"</span>)
}</pre></body></html></div>
<p><strong>bsub</strong> package automatically recognizes several format of time strings.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Zuguang Gu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
