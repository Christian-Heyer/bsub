<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Send R code/R scripts/shell commands to LSF cluster</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: #990073
   }

   pre .number {
     color: #099;
   }

   pre .comment {
     color: #998;
     font-style: italic
   }

   pre .keyword {
     color: #900;
     font-weight: bold
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: #d14;
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>



<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{Send R code/R scripts/shell commands to LSF cluster}
-->

<h1>Send R code/R scripts/shell commands to LSF cluster</h1>

<p><strong>Author</strong>: Zuguang Gu ( <a href="mailto:z.gu@dkfz.de">z.gu@dkfz.de</a> )</p>

<p><strong>Date</strong>: 2019-10-16</p>

<hr/>

<p>Load the library:</p>

<pre><code class="r">library(bsub)
</code></pre>

<p><strong>The <em>bsub</em> package works on the submission nodes, the computing nodes and the Rstudio node.</strong></p>

<p><strong>If the current node is not the submission node, a connection via ssh is automatically established.
You might be asked to enter password for the connection.</strong></p>

<h2>Send R code</h2>

<p>The code chunk should be embraced by <code>{...}</code>.</p>

<pre><code class="r">bsub_chunk(
{
    NMF::nmf(...)
})
</code></pre>

<p>In following examples, we use <code>Sys.sleep(5)</code> to simulate a chunk of code which runs for a short time.</p>

<pre><code class="r">bsub_chunk(
{
    Sys.sleep(5)
})
</code></pre>

<pre><code>## - job: &#39;R_code_c3481a47&#39; from a code chunk
## bsub -J &#39;R_code_c3481a47&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/R_code_c3481a47.out&#39; &#39;/home/guz/.bsub_temp/R_code_c3481a47_ac6978e78b7.sh&#39;
</code></pre>

<pre><code>## [1] &quot;1854164&quot;
</code></pre>

<p>The value returned by <code>bsub_chunk()</code> is the job ID from LSF cluster.</p>

<h3>Job settings</h3>

<p>Set job name, memory, running time and number of cores:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, memory = 10, hour = 10, core = 4, 
{
    Sys.sleep(5)
})
</code></pre>

<pre><code>## - job: &#39;example&#39; from a code chunk
## bsub -J &#39;example&#39; -W &#39;10:00&#39; -n 4 -R &#39;rusage[mem=10GB]&#39; -o &#39;/home/guz/.bsub_temp/example.out&#39; &#39;/home/guz/.bsub_temp/example_ac6910dc6775.sh&#39;
</code></pre>

<pre><code>## [1] &quot;1854165&quot;
</code></pre>

<p>If <code>name</code> is not specified, an internal name calculated by <code>digest::digest()</code> on the chunk
is automatically assigned. The unit of <code>memory</code> is GB. </p>

<h3>R version</h3>

<p>The R version can be specified by <code>R_version</code> argument.</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, R_version = &quot;3.6.0&quot;,
{
    Sys.sleep(5)
})
</code></pre>

<p><code>R_version</code> can be set as a global parameter:</p>

<pre><code class="r">bsub_opt$R_version = &quot;3.6.0&quot;
bsub_chunk(name = &quot;example&quot;, 
{
    Sys.sleep(5)
})
</code></pre>

<p>The R version is used for finding proper <code>Rscript</code> binary. More generally, <code>bsub_opt$call_Rscript</code> is
set as a function which returns the calling of <code>Rscript</code>. Also you can initialize other bash environment
variables there. The default is:</p>

<pre><code class="r">function(version) {
    qq(&quot;module load gcc/7.2.0; module load java/1.8.0_131; module load R/@{version}; Rscript&quot;)
}
</code></pre>

<p>where <code>version</code> is the value set in <code>bsub_opt$R_version</code>. <code>qq()</code> is from <em>GetoptLong</em> package which does
<a href="https://en.wikipedia.org/wiki/String_interpolation">variable interpolation</a>.</p>

<p>The module loading for <code>gcc/7.2.0</code> and <code>java/1.8.0_131</code> ensures that R packages depending on specific C/Java 
libraries can be successfully loaded.</p>

<h3>Load other packages</h3>

<p>The packages that are needed can be directly added in the code chunk:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;,
{
    library(package1)
    library(package2)
    Sys.sleep(5)
})
</code></pre>

<p>Or assign by <code>packages</code> argument:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, packages = c(&quot;package1&quot;, &quot;package2&quot;),
{
    Sys.sleep(5)
})
</code></pre>

<p>Or set it as a global parameter:</p>

<pre><code class="r">bsub_opt$packages = c(&quot;package1&quot;, &quot;package2&quot;)
bsub_chunk(name = &quot;example&quot;,
{
    Sys.sleep(5)
})
</code></pre>

<h3>Other R variables</h3>

<p>The R variables that are defined outside the code chunk and need to be used
inside the code chunk can by specified by <code>variables</code> argument:</p>

<pre><code class="r">foo = 1
bsub_chunk(name = &quot;example&quot;, variables = &quot;foo&quot;,
{ 
    bar = foo
    Sys.sleep(5)
})
</code></pre>

<h3>The workspace image</h3>

<p>If you have too many external variables that are used in the code chunk or
they are used in multiple jobs, you can directly save the workspace or the objects as an
image and specify the <code>image</code> argument:</p>

<pre><code class="r">save.image(file = &quot;/path/foo.RData&quot;)
# or 
# save(var1, var2, ..., file = &quot;...&quot;)
bsub_chunk(name = &quot;example&quot;, image = &quot;/path/foo.RData&quot;,
{ 
    ...
    Sys.sleep(5)
})
</code></pre>

<p>Or set the image file as a global parameter:</p>

<pre><code class="r">save.image(file = &quot;/path/foo.RData&quot;)
bsub_opt$image = &quot;/path/foo.RData&quot;
bsub_chunk(name = &quot;example&quot;,
{ 
    ...
    Sys.sleep(5)
})
</code></pre>

<p>Absolute paths should be used instead of relative paths.</p>

<h3>The working directory</h3>

<p>If the code chunk replies on the working directory, it can be specified by <code>wd</code> argument:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, wd = &quot;/path&quot;
{ 
    Sys.sleep(5)
})
</code></pre>

<p>Or set it as a global parameter:</p>

<pre><code class="r">bsub_opt$wd = &quot;/path&quot;
bsub_chunk(name = &quot;example&quot;,
{ 
    Sys.sleep(5)
})
</code></pre>

<p>Absolute path should be used.</p>

<h3>Retrieve the last variable</h3>

<p>The last variable in the code chunk can be saved by setting <code>save_var = TRUE</code> and retrieved back
by <code>retrieve_var()</code> by specifying the job name. Since the variable is looked up by the job name,
there should be no job with the same name submitted before retrieving the variable.</p>

<p><code>retrieve_var()</code> waits until the job is finished.</p>

<pre><code class="r">bsub_chunk(name = &quot;example2&quot;, save_var = TRUE,
{
    Sys.sleep(10)
    1+1
})
</code></pre>

<pre><code>## - job: &#39;example2&#39; from a code chunk
## bsub -J &#39;example2&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/example2.out&#39; &#39;/home/guz/.bsub_temp/example2_ac6932a3ad55.sh&#39;
</code></pre>

<pre><code>## [1] &quot;1854166&quot;
</code></pre>

<pre><code class="r">retrieve_var(&quot;example2&quot;)
</code></pre>

<pre><code>## job is running or pending, retry in 30 seconds.
</code></pre>

<pre><code>## [1] 2
</code></pre>

<p>However, it is not suggested to directly retrieve the returned value from the code chunk. Better choice
is to save the variable into permanent file in the code chunk, E.g.:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, 
{
    ...
    save(...)
    # or
    saveRDS(...)
})
</code></pre>

<h3>Rerun the job</h3>

<p>There is a flag file to mark whether the job was successfully finished or not.
If the job has been successfully done, the job with the same name will be
skipped. <code>enforce</code> argument controls how to rerun the jobs with the same
names. If it is set to <code>TRUE</code>, jobs will be rerun no matter they are done or not.</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, enforce = FALSE,
{ 
    Sys.sleep(5)
})
</code></pre>

<pre><code>## Job &#39;example&#39; is already done, skip.
</code></pre>

<p><code>enforce</code> can be set as a global parameter:</p>

<pre><code class="r">bsub_opt$enforce = FALSE
bsub_chunk(name = &quot;example&quot;,
{ 
    Sys.sleep(5)
})
</code></pre>

<h3>Job dependency</h3>

<p>Since <code>bsub_chunk()</code> returns the job ID, it is can be used to specify the dependency in other jobs.
The value for <code>dependency</code> can be a vector of job IDs.</p>

<pre><code class="r">job1 = bsub_chunk(name = &quot;example1&quot;,
{ 
    Sys.sleep(5)
})
bsub_chunk(name = &quot;example2&quot;, dependency = job1,
{ 
    Sys.sleep(5)
})
</code></pre>

<h3>Temporary and output directory</h3>

<p><code>bsub_chunk()</code> has two arguments <code>temp_dir</code> and <code>output_dir</code>. <code>temp_dir</code> is used for the temporary R script
and sh files. <code>output_dir</code> is used for the flag files and the output files from LSF cluster.</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, temp_dir = ..., output_dir = ...,
{ 
    Sys.sleep(5)
})
</code></pre>

<p>They can be set as global parameters. The value of <code>output_dir</code> is by default set as the same as <code>temp_dir</code>.</p>

<pre><code class="r">bsub_opt$temp_dir = ...
bsub_opt$output_dir = ...
bsub_chunk(name = &quot;example&quot;,
{ 
    Sys.sleep(5)
})
</code></pre>

<p>To remove temporary files in <code>temp_dir</code>, run <code>clear_temp_dir()</code> function.</p>

<h3>Run code chunk from a script</h3>

<p>You can run code chunk from a script by specifying the starting line number
and the ending line number. The R script is specified by <code>script</code> argument,
the starting line number and the ending line number are specified by <code>start</code>
and <code>end</code> arguments. (Note this functionality has not been tested yet.)</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;,
    script = &quot;/path/foo.R&quot;,
    start = 10, end = 20, ...)
</code></pre>

<p>Assume you are editing <code>foo.R</code> very offen and the line numbers that you want
to run change from time to time. You can add tags in the R script and
specifying <code>start</code> and <code>end</code> by those tags. In following example which is the
source code of <code>foo.R</code>, we add tags for the code chunk we want to run:</p>

<pre><code class="r">...
# BSUB_START
you code chunk here
# BSUB_END
...
</code></pre>

<p>Then you can specify <code>start</code> and <code>end</code> by regular expressions to match them:</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;,
    script = &quot;/path/foo.R&quot;,
    start = &quot;^# BSUB_START&quot;, 
    end = &quot;^# BSUB_END&quot;, ...)
</code></pre>

<h3>Run jobs locally</h3>

<p>Setting <code>local = TRUE</code> directly runs the code chunk in the same R session.</p>

<pre><code class="r">bsub_chunk(name = &quot;example&quot;, local = TRUE,
{ 
    cat(&quot;blablabla...\n&quot;)
})
</code></pre>

<pre><code>## - job: &#39;example&#39; from a code chunk
## bash /home/guz/.bsub_temp/example_ac69747d5168.sh
</code></pre>

<h2>Send R script</h2>

<p><code>bsub_script()</code> submits the job from R scripts. The major arguments are the same as in <code>bsub_chunk()</code>.</p>

<pre><code class="r">bsub_script(&quot;/path/foo.R&quot;, name = ..., memory = ..., core = ..., ...)
</code></pre>

<p>If the R script needs command-line arguments, they can be specified by <code>argv</code>.</p>

<pre><code class="r">bsub_script(&quot;/path/foo.R&quot;, argv = &quot;--a 1 --b 3&quot;, ...)
</code></pre>

<p>The command-line arguments can also specified as arguments of <code>bsub_script()</code>,
but with <code>.</code> prefix.</p>

<pre><code class="r">bsub_script(&quot;/path/foo.R&quot;, .a = 1, .b = 3, ...)
</code></pre>

<p>The R scripts should be used with the absolute paths.</p>

<h2>Send other shell commands</h2>

<p><code>bsub_cmd()</code>submits shell commands. Basically it is similar as <code>bsub_script()</code>:</p>

<pre><code class="r">bsub_cmd(&quot;samtools sort ...&quot;, name = ..., memory = ..., core = ..., ...)
bsub_cmd(c(&quot;cmd1&quot;, &quot;cmd2&quot;, ...), name = ..., memory = ..., core = ..., ...)
</code></pre>

<p>The binary and the arguments should all be set in the first argument of <code>bsub_cmd()</code>.</p>

<h2>Global Parameters</h2>

<pre><code class="r">bsub_opt
</code></pre>

<pre><code>##           Option                                           Value
##         packages                                            NULL
##            image                                            NULL
##         temp_dir                            /home/guz/.bsub_temp
##       output_dir                            /home/guz/.bsub_temp
##          enforce                                            TRUE
##        R_version                                           3.6.0
##               wd                                              &quot;&quot;
##           ignore                                           FALSE
##            local                                           FALSE
##     call_Rscript                         a user-defined function
##  submission_node odcf-worker01, odcf-cn34u03s10, odcf-cn34u03s12
</code></pre>

<h2>Other functions</h2>

<ul>
<li><code>bjobs()</code> or just entering <code>bjobs</code> gives a summary of running jobs. Job status (by default is <code>RUN</code>
and <code>PEND</code>) is controlled by <code>status</code> argument. Number of most recent jobs is controlled by <code>max</code> argument.
Filtering on the job name is controlled by <code>filter</code> argument.</li>
<li><code>job_log(job_id)</code> prints the log of a specified running/finished/failed job.</li>
<li><code>ssh_connect()</code> establishes the SSH connection to the submission node if it is lost.</li>
</ul>

<pre><code class="r">library(GetoptLong)
for(i in 1:4) {
    bsub_chunk(name = qq(&quot;example_@{i}&quot;),
    { 
        Sys.sleep(5)
    })
}
</code></pre>

<pre><code>## - job: &#39;example_1&#39; from a code chunk
## bsub -J &#39;example_1&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/example_1.out&#39; &#39;/home/guz/.bsub_temp/example_1_ac69641dfc22.sh&#39; 
## - job: &#39;example_2&#39; from a code chunk
## bsub -J &#39;example_2&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/example_2.out&#39; &#39;/home/guz/.bsub_temp/example_2_ac695c52616c.sh&#39; 
## - job: &#39;example_3&#39; from a code chunk
## bsub -J &#39;example_3&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/example_3.out&#39; &#39;/home/guz/.bsub_temp/example_3_ac696562be66.sh&#39; 
## - job: &#39;example_4&#39; from a code chunk
## bsub -J &#39;example_4&#39; -W &#39;1:00&#39; -n 1 -R &#39;rusage[mem=1GB]&#39; -o &#39;/home/guz/.bsub_temp/example_4.out&#39; &#39;/home/guz/.bsub_temp/example_4_ac691a4b3984.sh&#39;
</code></pre>

<pre><code class="r">bjobs
</code></pre>

<pre><code>##  JOBID   STAT JOB_NAME   TIME_PASSED TIME_LEFT SLOTS MEM   MAX_MEM
##  1853840 RUN  test_Golub 2:25        97:34     4     912Mb 1.7Gb  
##  1854167 PEND example_1  -           -         -     -     -      
##  1854168 PEND example_2  -           -         -     -     -      
##  1854169 PEND example_3  -           -         -     -     -      
##  1854170 PEND example_4  -           -         -     -     -      
## ================================================================== 
##  11 DONE jobs, 4 PEND jobs, 1 RUN job within one week.
##  You can have more controls by `bjobs(status = ..., max = ..., filter = ...)`.
</code></pre>

<p>There is one additional column <code>RECENT</code> in the summary table which shows the order
of the jobs with the same job name. The most recent job has the value 1.</p>

<pre><code class="r">bjobs(status = &quot;all&quot;, filter = &quot;example&quot;)
</code></pre>

<pre><code>##  JOBID   STAT JOB_NAME  RECENT TIME_PASSED TIME_LEFT SLOTS MEM MAX_MEM
##  1853846 DONE example   2      0:00        -         4     -   12Mb   
##  1853847 DONE example2  2      0:00        -         1     -   37Mb   
##  1853848 DONE example_1 2      0:00        -         1     -   37Mb   
##  1853849 DONE example_2 2      0:00        -         1     -   37Mb   
##  1853850 DONE example_3 2      0:00        -         1     -   37Mb   
##  1853851 DONE example_4 2      0:00        -         1     -   37Mb   
##  1854165 DONE example   1      0:00        -         4     -   7Mb    
##  1854166 DONE example2  1      0:00        -         1     -   41Mb   
##  1854167 PEND example_1 1      -           -         -     -   -      
##  1854168 PEND example_2 1      -           -         -     -   -      
##  1854169 PEND example_3 1      -           -         -     -   -      
##  1854170 PEND example_4 1      -           -         -     -   -      
## ====================================================================== 
##  11 DONE jobs, 4 PEND jobs, 1 RUN job within one week.
##  You can have more controls by `bjobs(status = ..., max = ..., filter = ...)`.
</code></pre>

<p><code>brecent()</code> returns 20 most recent jobs.</p>

<pre><code class="r">brecent
</code></pre>

<pre><code>##  JOBID   STAT JOB_NAME        RECENT TIME_PASSED TIME_LEFT SLOTS MEM   MAX_MEM
##  1837363 DONE test_Golub      2      2:03        -         4     -     1.7Gb  
##  1853840 RUN  test_Golub      1      2:25        97:34     4     912Mb 1.7Gb  
##  1853845 DONE R_code_c3481a47 2      0:00        -         1     -     37Mb   
##  1853846 DONE example         2      0:00        -         4     -     12Mb   
##  1853847 DONE example2        2      0:00        -         1     -     37Mb   
##  1853848 DONE example_1       2      0:00        -         1     -     37Mb   
##  1853849 DONE example_2       2      0:00        -         1     -     37Mb   
##  1853850 DONE example_3       2      0:00        -         1     -     37Mb   
##  1853851 DONE example_4       2      0:00        -         1     -     37Mb   
##  1854164 DONE R_code_c3481a47 1      0:00        -         1     -     14Mb   
##  1854165 DONE example         1      0:00        -         4     -     7Mb    
##  1854166 DONE example2        1      0:00        -         1     -     41Mb   
##  1854167 PEND example_1       1      -           -         -     -     -      
##  1854168 PEND example_2       1      -           -         -     -     -      
##  1854169 PEND example_3       1      -           -         -     -     -      
##  1854170 PEND example_4       1      -           -         -     -     -      
## ============================================================================== 
##  11 DONE jobs, 4 PEND jobs, 1 RUN job within one week.
##  You can have more controls by `bjobs(status = ..., max = ..., filter = ...)`.
</code></pre>

<h2>Session Info</h2>

<pre><code class="r">sessionInfo()
</code></pre>

<pre><code>## R version 3.6.0 (2019-04-26)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: CentOS Linux 7 (Core)
## 
## Matrix products: default
## BLAS:   /usr/lib64/libblas.so.3.4.2
## LAPACK: /usr/lib64/liblapack.so.3.4.2
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=C              
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] GetoptLong_0.1.7 bsub_0.0.2      
## 
## loaded via a namespace (and not attached):
##  [1] compiler_3.6.0      rjson_0.2.20        magrittr_1.5       
##  [4] tools_3.6.0         GlobalOptions_0.1.1 stringi_1.4.3      
##  [7] knitr_1.25          digest_0.6.21       stringr_1.4.0      
## [10] xfun_0.9            evaluate_0.14
</code></pre>

</body>

</html>
